<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DropX Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <h1>DropX</h1>
  <div>
    <button onclick="showTab('home')">Home</button>
    <button onclick="showTab('deliveries')">My Deliveries</button>
    <button onclick="showTab('newdelivery')">New Delivery</button>
    <button onclick="logout()">Logout</button>
  </div>
</header>

<main>
  <section id="homeTab" class="active tab">
    <h2>Welcome to DropX!</h2>
    <p>Manage your drone deliveries easily.</p>
  </section>

  <section id="deliveriesTab" class="tab">
    <h2>My Deliveries</h2>
    <div id="deliveriesList"></div>
  </section>

  <section id="newdeliveryTab" class="tab">
    <h2>Request New Delivery</h2>
    <input type="text" id="newAddress" placeholder="Enter delivery address">
    <button id="addBtn">Add Delivery</button>
    <div id="qrContainer"></div>
  </section>
</main>

<div class="popup" id="popup">
  <div class="popup-content" id="popupContent"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
if(localStorage.getItem('dropx_loggedin')!=='true') window.location.href='login.html';

const user = JSON.parse(localStorage.getItem('dropx_user'));
const userKey = `dropx_deliveries_${user.email}`;
const popup = document.getElementById('popup');
const popupContent = document.getElementById('popupContent');

function showPopup(msg){
  popupContent.innerHTML = msg + '<br><br><button onclick="closePopup()">OK</button>';
  popup.style.display = 'flex';
}
function closePopup(){ popup.style.display = 'none'; }
function logout(){ localStorage.removeItem('dropx_loggedin'); window.location.href='login.html'; }
function showTab(tab){ 
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + 'Tab').classList.add('active');
}

function renderDeliveries(){
  const list = document.getElementById('deliveriesList');
  list.innerHTML = '';
  const deliveries = JSON.parse(localStorage.getItem(userKey)) || [];
  if(deliveries.length===0){ list.innerHTML='<p>No deliveries yet.</p>'; return; }
  deliveries.forEach(d=>{
    const div = document.createElement('div');
    div.className='delivery';
    div.innerHTML = `<strong>Package #${d.id}</strong><br>Address: ${d.address}<br>GPS: ${d.lat}, ${d.lon}<br>Status: ${d.status}`;
    list.appendChild(div);
  });
}

function addDelivery(){
  const addressInput = document.getElementById('newAddress');
  const address = addressInput.value.trim();
  if(!address) return showPopup('Please enter an address.');

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
    .then(res => res.json())
    .then(data => {
      if(!data || data.length===0) return showPopup('Address not found.');

      const {lat, lon, display_name} = data[0];
      const delivery = {id:Date.now(), address:display_name, lat, lon, status:'Pending'};

      let deliveries = JSON.parse(localStorage.getItem(userKey)) || [];
      deliveries.push(delivery);
      localStorage.setItem(userKey, JSON.stringify(deliveries));

      renderDeliveries();
      addressInput.value='';

      // Generate QR code
      const qrContainer = document.getElementById('qrContainer');
      qrContainer.innerHTML='';
      const qrText = `Email: ${user.email}\nCoordinates: ${lat}, ${lon}`;
      const qr = new QRCode(qrContainer, {text: qrText, width:200, height:200});

      showPopup('Delivery added successfully!');

      // Convert QR to base64 and send email via backend
      // After QR is generated
      setTimeout(() => {
        const canvas = document.querySelector('#qrContainer canvas');
        if (!canvas) return;

        const qrBase64Full = canvas.toDataURL('image/jpeg'); // use the correct MIME
        const qrBase64 = qrBase64Full.replace(/^data:image\/jpeg;base64,/, ''); // strip header


        fetch('http://localhost:3000/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
            to: user.email,
            subject: 'DropX Delivery QR Code',
            text: `Coordinates: ${lat}, ${lon}\nEmail: ${user.email}`,
            qrBase64
            })
        })
        .then(r => r.json())
        .then(d => console.log(d))
        .catch(e => console.error('Email send failed', e));
        }, 500); // allow QR to render fully
    })
    .catch(()=>showPopup('Error fetching location.'));
}

document.getElementById('addBtn').addEventListener('click', addDelivery);
document.addEventListener('keydown', e=>{
  if(e.key==='Enter' && document.getElementById('newdeliveryTab').classList.contains('active')) addDelivery();
});

renderDeliveries();
</script>
</body>
</html>
